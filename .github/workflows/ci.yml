# CI Pipeline for tradingBot-SwingTrader
# Runs tests and validates package on every push and PR

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  PYTHON_VERSION: '3.11'

jobs:
  # =============================================================================
  # TEST - Run unit tests and validate package
  # =============================================================================
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Configure git for private repos
        run: |
          git config --global url."https://${{ secrets.GH_PAT }}@github.com/".insteadOf "https://github.com/"

      - name: Install package and dependencies
        run: |
          pip install -e ".[dev]"

      - name: Run tests
        run: |
          if [ -n "$(find tests -name '*.py' -type f 2>/dev/null)" ]; then
            pytest tests/ -v --tb=short
          else
            echo "No tests found yet - skipping pytest"
          fi

      - name: Validate tradingbot-core imports
        run: |
          python -c "
          # Validate core library imports
          from tradingbot_core import Position, Trade, OrderResult, OrderStatus
          from tradingbot_core.utils import TechnicalIndicators
          from tradingbot_core.services import BalanceService, MarketDataService, SystemStateService, TaxService
          from tradingbot_core.brokers import BrokerClient, AlpacaBroker
          print('All tradingbot-core imports successful')
          "

      - name: Validate local package structure
        run: |
          python -c "
          import sys
          sys.path.insert(0, 'src')
          # Validate src modules can be loaded
          from strategies import *
          from services import *
          print('Local package structure validated')
          " || echo "Local imports skipped - package structure not yet complete"
